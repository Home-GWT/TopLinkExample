
PL/SQL — процедурный блочно-структурированный язык.
---


    > Создание пакетов, процедур и функций, хранимых в базе данных.
    > Предоставление интерфейса для вызова внешних процедур.
    > Поддержка типов данных SQL и внутренних типов PL/SQL.
    > Работа с курсором.
    > Механизм обработки исключений.
    
    > Не чувствителен к регистру (кроме строковых переменных и констант).
    > Каждая конструкция PL/SQL должна заканчиваться символом ;
    > Одна конструкция может быть расположена на нескольких строках.
    
    > Блок — основная структурная единица PL/SQL.
      Блок позволяет объединять объявления и операторы, связанные общей логикой.
      >> Может быть анонимным или именованным.
      >> Может содержать вложенные блоки.
      >> Составные части блока:
         секция объявлений;
         тело блока (обязательная часть);
         обработчики исключений.

```sql
DECLARE
  -- Объявление переменных, типов, курсоров и проч.
BEGIN
  -- Код программы (обязательная часть блока)
EXCEPTION
  -- Обработка исключений
END;
/* Многострочные
комментарии… */
-- Однострочный комментарий
```

####Переменные:
    Могут иметь тип данных SQL или PL/SQL.
    Объявляются в секциях объявлений блоков PL/SQL.
    Видны внутри блока, в котором они объявлены.
    Получают тип данных при объявлении.
    Могут быть проинициализированы значением при объявлении.

================================
---

    3 Слайд: Часть 1. Структура кода в PL/SQL
        3.1 Слайд: Блоки PL/SQL
        3.4 Слайд: Объявление переменных
        3.7 Слайд: Операторы выбора (IF)
        3.8 Слайд: Операторы выбора (CASE)
        3.11 Слайд: Операторы цикла (простой LOOP)
        3.12 Слайд: Операторы цикла (WHILE LOOP)
        3.13 Слайд: Операторы цикла (FOR LOOP)
        3.15 Слайд: Операторы перехода (GOTO)
    4 Слайд: Часть 2. Основные типы и структуры данных
        4.1 Слайд: Типы данных
        4.4 Слайд: Приведение типов
        4.6 Слайд: Коллекции
        4.9 Слайд: Записи
        4.11 Слайд: Атрибуты типизации
    5 Слайд: Часть 3. Взаимодействие с БД
        5.1 Слайд: Извлечение и обработка данных
        5.5 Слайд: Курсоры
        5.12 Слайд: Вызовы SQL в PL/SQL-ном блоке
        5.14 Слайд: Динамический SQL — пример
        5.15 Слайд: Управление изменениями
        5.18 Слайд: Триггеры
    6 Слайд: Часть 4. Исключения
        6.1 Слайд: Обработка ошибок
        6.3 Слайд: Предопределенные исключения
        6.4 Слайд: Объявление исключений
    7 Слайд: Часть 5. Подпрограммы
        7.1 Слайд: Функции, процедуры
        7.6 Слайд: Параметры
        7.9 Слайд: Перегрузка функций, процедур
        7.11 Слайд: Рекурсивный вызов
    8 Слайд: Часть 6. Пакеты PL/SQL
        8.1 Слайд: Структура пакета
        8.3 Слайд: Доступ к элементам пакета
        8.4 Слайд: Инициализация данных пакета
    9 Слайд: Часть 7. И еще...
        9.1 Слайд: Получение информации из запроса/блока/функции
        9.3 Слайд: Системные представления
        9.4 Слайд: Механизм заданий (jobs)
        9.7 Слайд: Коротко об sqlplus

================================
---

Курсор — получаемый при выполнении запроса результирующий набор записей плюс привязанный к нему указатель текущей записи.
####Курсоры:
    Явные (объявляются разработчиком).
    Неявные (не требуют объявления, управляются автоматически).
####Состояние курсора — атрибуты:
     %ISOPEN
     %FOUND
     %NOTFOUND
     %ROWCOUNT

######Триггеры на события DML (на строку/на операцию).
######Триггеры INSTEAD OF.
######Триггеры на события DDL.
######Триггеры на события уровня схемы/БД
    
    1. Обработка ошибок
    2. Предопределенные исключения
    3. Объявление исключений
    Исключение — ошибка времени выполнения.
        Нормальное выполнение блока прекращается.
        Управление возвращается внешнему (вызвавшему) блоку.
        ...до тех пор, пока исключение не будет «перехвачено» и обработано:
            выдано user-friendly сообщение пользователю;
            записано в лог;
            проигнорировано;

Подпрограмма — именованный блок PL/SQL, который может иметь параметры вызова.
Аналогично анонимным блокам могут быть вложенными.
```sql
PROCEDURE процедура (параметры) AS
  -- Объявление переменных, типов, курсоров и проч.
BEGIN
  -- Код процедуры (обязательная часть подпрограммы)
EXCEPTION
  -- Обработка исключений
END процедура;
```

######Функция — возвращает некоторое значение.
	
```sql
FUNCTION функция (параметры)
  RETURN тип_значения
AS
  -- Объявление переменных, типов, курсоров и проч.
BEGIN
  -- Код функции (обязательная часть подпрограммы)
EXCEPTION
  -- Обработка исключений
END функция;
```

######Пакет — хранимый объект, объединяющий логически близкие типы, данные, подпрограммы.

```sql
CREATE OR REPLACE PACKAGE пакет AS
  TYPE какой_то_тип AS /*...*/;
  какая_то_переменная тип;
  PROCEDURE какая_то_процедура;
  FUNCTION какая_то_функция RETURN тип;
  --...
END пакет;
```

Утилита SQL*Plus: позволяет выполнять команды SQL и блоки PL/SQL.
sqlplus — работа в окне командной строки
sqlplusw — оконная версия

sqlplus /NOLOG @script.sql param1 param2

/*script.sql*/
```sql
-- Определить код возврата при ошибке
WHENEVER SQLERROR EXIT -1 ROLLBACK
-- Подключиться к БД (параметризовано)
CONNECT &1/&2@ORAXE;
-- Включить вывод
SET SERVEROUTPUT ON;
-- Логировать действия в файл
SPOOL test.log;
-- Объявить и присвоить bind-переменную
var v_cnt NUMBER;
EXEC :v_cnt := 30;
-- Выполнить команду SQL
SELECT * FROM emp WHERE deptno = :v_cnt;
-- Выполнить блок PL/SQL
BEGIN
    dbms_output.put_line('Listed employees for deptno '|| :v_cnt);
END;
/
-- Выйти с кодом "успешно"
EXIT 0;
```

    1. Типы данных
       Простые (скалярные) типы (простые значения без внутренних составляющих):
        NUMBER(точность, масштаб) — число с плавающей точкой;
        CHAR2(размер) — строка постоянной длины;
        VARCHAR2(макс_размер) — строка переменной длины;
        DATE — дата (со временем);
        BOOLEAN — логическое значение;
       Составные типы (структуры из определенных компонент):
        TABLE — коллекция;
        VARRAY — массив;
        RECORD — запись.
       Ссылочные типы: ссылка на объект, например REF CURSOR.
       LOB типы: «локатор», определяющий расположение больших объектов данных (графика, файлы,...):
        BFILE — внешний двоичный файл;
        BLOB — внутренний двоичный объект;
        CLOB — внутренний символьный объект.
    2. Приведение типов
         Явное:
            TO_NUMBER()
            TO_CHAR()
            TO_DATE()
            ...
        Неявное.
    3. Коллекции
        Таблицы PL/SQL (TABLE)
        Массивы (VARRAY)
       Методы работы с коллекциями:
        EXISTS(индекс_элемента) — существует ли элемент по индексу?
        COUNT — количество элементов в коллекции.
        LIMIT — размер varray-массива.
        DELETE(с_элемента, по_элемент) — удалить элементы: все; один; диапазон.
        FIRST, LAST — индексы первого и последнего элемента.
        PRIOR(индекс_элемента), NEXT(индекс_элемента) — индексы следующего и предыдущего элемента.
    4. Записи (RECORD)
    5. Атрибуты типизации
         %TYPE
            Объявление переменной с типом другой переменной.
            Объявление переменной с типом поля таблицы в БД.
         %ROWTYPE
            Объявление переменной типа запись, по структуре соответствующей строке таблицы в БД.

######Взаимодействие с БД:
1. Извлечение и обработка данных
2. Курсоры
3. Вызовы SQL в PL/SQL-ном блоке
4. Управление изменениями
5. Триггеры


    Управление изменениями
    Транзакция — последовательность действий с БД, которая:
        или полностью фиксируется в БД,
        или полностью отменяется.
    Все SQL-операторы входят в одну транзакцию до тех пор, пока не будет сделана ее фиксация (COMMIT) или откат (ROLLBACK).
        Уровни изоляции транзакций.
    
    Сложная (поэтапная) логика действий с БД: промежуточные точки отката
    -- Начало действий с БД
    --...
    SAVEPOINT имя; -- Точка отката
    -- Логически сгруппированные действия, которые если что следует
    -- откатывать вместе без отката всей транзакции
    ROLLBACK TO SAVEPOINT имя;
    --...
    COMMIT; -- Фиксация транзакции
    
    Фиксация изменений в БД даже при откате транзакции: автономные транзакции
        PRAGMA AUTONOMOUS_TRANSACTION;
    Блокировки.

================================
---

```sql
/* Пакет реализует API доступа к данным сотрудников:
- получение имени сотрудника по его номеру
- получение названия подразделения сотрудника по его номеру
Обращения к БД кешируются.
*/
CREATE OR REPLACE PACKAGE pk_emp AS
    FUNCTION get_name(a_empno NUMBER) RETURN VARCHAR2;
    FUNCTION get_dept(a_empno NUMBER) RETURN VARCHAR2;
END pk_emp;

CREATE OR REPLACE PACKAGE BODY pk_emp AS
    TYPE TStringArray IS TABLE OF VARCHAR2(100) INDEX BY BINARY_INTEGER;
    la_emp TStringArray;
    la_dept TStringArray;
    FUNCTION get_name(a_empno NUMBER) RETURN VARCHAR2
    AS
    BEGIN
        IF NOT la_emp.EXISTS(a_empno) THEN
            SELECT ename INTO la_emp(a_empno)
                FROM emp
                WHERE empno = a_empno;
        END IF;
        RETURN la_emp(a_empno);
    END get_name;
    FUNCTION get_dept(a_empno NUMBER) RETURN VARCHAR2
    AS
    BEGIN
        RETURN la_dept(a_empno);
    END get_dept;
BEGIN
    FOR lc IN (SELECT empno, dname FROM emp e, dept d WHERE d.deptno = e.deptno)
    LOOP
        la_dept(lc.empno) := lc.dname;
    END LOOP;
END pk_emp;
```
